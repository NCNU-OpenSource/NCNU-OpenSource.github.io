<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-65940060-4","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>

<title data-react-helmet="true">Week15</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="NCNU OpenSource · OpenSource related in NCNU"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="# Week 15(2019/05/30) - 自動測試、Linux Asynchronous"><meta data-react-helmet="true" property="og:description" content="# Week 15(2019/05/30) - 自動測試、Linux Asynchronous"><meta data-react-helmet="true" property="og:url" content="https://lsa.moli.rocks//docs/1072/Week15">

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico">


<link rel="stylesheet" href="/styles.46a4ecd5.css">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}function e(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}var n=window.matchMedia("(prefers-color-scheme: dark)");n.addListener((function(n){null===e()&&t(n.matches?"dark":"")}));var a=e();null!==a?t(a):n.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong>NCNU OpenSource</strong></a><a class="navbar__item navbar__link" href="/docs/readme">Notes</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/NCNU-OpenSource/">GitHub</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://t.me/MOLi_rocks">Telegram</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong>NCNU OpenSource</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/readme">Notes</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/NCNU-OpenSource/">GitHub</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://t.me/MOLi_rocks">Telegram</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">101</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/101/1011-OSA-Mopad">1011-OSA-Mopad</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/101/1012-OSA-Mopad">1012-OSA-Mopad</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">102</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/102/1021-LSA-Mopad">1021-LSA-Mopad</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/102/1021-OSA-Mopad">1021-OSA-Mopad</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/102/1022-OSA-Mopad">1022-OSA-Mopad</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/102/OSSG-MoPad-RaspberryPi">OSSG-MoPad-RaspberryPi</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">1032</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-2-3-Disk-Partitioning-and-FHS">Week-2-3-Disk-Partitioning-and-FHS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-3-4-Package-Management-Command-Line">Week-3-4-Package-Management-Command-Line</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-4-LAMP-Drupal-and-Tther-HTTPd">Week-4-LAMP-Drupal-and-Tther-HTTPd</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-5-Virtual-host-Apache-lighttpd">Week-5-Virtual-host-Apache-lighttpd</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-6-Nagios-Aptitude-top-iftop-iotop">Week-6-Nagios-Aptitude-top-iftop-iotop</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-8-FTP-TCPIP-iptable">Week-8-FTP-TCPIP-iptable</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-9-Samba-Three-way-Handshake-iptable">Week-9-Samba-Three-way-Handshake-iptable</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1032/Week-10-Minecraft">Week-10-Minecraft</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">1041</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-1">Week-1</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-2-Install-Ubuntu,-FHS">Week-2-Install-Ubuntu,-FHS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-3-OSS-History-FHS">Week-3-OSS-History-FHS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week4-Command-line">Week4-Command-line</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week5">Week5</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week7">Week7</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-8-Samba">Week-8-Samba</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-9-Network-Design">Week-9-Network-Design</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-10-VCS">Week-10-VCS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-11-Raspberry-pi">Week-11-Raspberry-pi</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-12-Raspberry-pi">Week-12-Raspberry-pi</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1041/Week-13-security">Week-13-security</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">1061</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-2">Week-2</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-4">Week-4</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-5">Week-5</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-7">Week-7</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-8">Week-8</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-9">Week-9</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-10">Week-10</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-11">Week-11</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-12">Week-12</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-13">Week-13</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-14">Week-14</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1061/Week-16">Week-16</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">1062</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-01-Linux-Basic">Week-01-Linux-Basic</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-01-Web-Servers">Week-01-Web-Servers</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-02">Week-02</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-03-Other-Shells">Week-03-Other-Shells</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-03">Week-03</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-04">Week-04</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-05">Week-05</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-06">Week-06</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-07">Week-07</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-08">Week-08</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-09">Week-09</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-10">Week-10</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-11-Backup">Week-11-Backup</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-12">Week-12</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-13">Week-13</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1062/Week-14">Week-14</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">1071</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week1">Week1</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week2">Week2</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week3">Week3</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week4">Week4</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week5">Week5</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week6">Week6</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week7">Week7</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week8">Week8</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week9">Week9</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week10">Week10</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week11">Week11</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week12">Week12</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week13">Week13</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week14">Week14</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week15">Week15</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week16">Week16</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1071/Week17">Week17</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">1072</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week3">Week3</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week4">Week4</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week5">Week5</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week6">Week6</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week8">Week8</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week9">Week9</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week10">Week10</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week11">Week11</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week12">Week12</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week13">Week13</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week14">Week14</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/1072/Week15">Week15</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1072/Week18">Week18</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">1081</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week2">Week2</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week3">Week3</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week4">Week4</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week5">Week5</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week6">Week6</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week7">Week7</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week8">Week8</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week9">Week9</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week10">Week10</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week11">Week11</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week12">Week12</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week13">Week13</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week14">Week14</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1081/Week15">Week15</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Readme</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/readme">readme</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Week15</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor" id="week-1520190530---自動測試、linux-asynchronous"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#week-1520190530---自動測試、linux-asynchronous" title="Direct link to heading">#</a>Week 15(2019/05/30) - 自動測試、Linux Asynchronous</h1><p>自動測試簡報 : <a href="https://docs.google.com/presentation/d/17LyztipJfLjisX3Xdi9DuHQwR2gw1hl7tvd9jcSZyqM/edit?usp=sharing">簡報</a>  <strong>- Page.73</strong></p><h1><a aria-hidden="true" tabindex="-1" class="anchor" id="自動測試"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#自動測試" title="Direct link to heading">#</a>自動測試</h1><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="node-js"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#node-js" title="Direct link to heading">#</a>Node js</h3><h5><a aria-hidden="true" tabindex="-1" class="anchor" id="安裝"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#安裝" title="Direct link to heading">#</a>安裝</h5><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-undefined codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">+ sudo apt-get install nodejs</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="vs-code"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#vs-code" title="Direct link to heading">#</a>VS Code</h3><h5><a aria-hidden="true" tabindex="-1" class="anchor" id="安裝步驟"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#安裝步驟" title="Direct link to heading">#</a>安裝步驟</h5><ul><li>官網下載 Visual Studio Code 安裝檔(.deb) <ul><li><a href="https://code.visualstudio.com/docs/?dv=linux64_deb">鏈結 Link</a></li></ul></li><li><code>cd &lt;VS Code 安裝檔所在目錄&gt;</code></li><li><code>sudo dpkg -i &lt;VS Code 安裝檔&gt;.deb</code></li><li>開啟程式<ul><li><code>code</code></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="tdd-test-driven-development"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#tdd-test-driven-development" title="Direct link to heading">#</a>TDD (Test-Driven Development)</h3><ul><li>強調先寫測試程式才開發程式。<ul><li>Red–Green–Refactor cycle 循環<ul><li>Red <ul><li>失敗的測試</li></ul></li><li>Green <ul><li>符合預期的測試</li></ul></li><li>Refactor <ul><li>去除多餘的Code，但必須讓程式通過</li><li></li></ul></li></ul></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="bdd-behavior-driven-development"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#bdd-behavior-driven-development" title="Direct link to heading">#</a>BDD (Behavior Driven Development)</h3><ul><li>強調規格文件和測試之間的關係。<ul><li>User Story <ul><li>Given </li><li>When</li><li>Then</li></ul></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="first-rules"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#first-rules" title="Direct link to heading">#</a>FIRST Rules</h3><ol><li>Fast 跑得快</li><li>Independent 測試獨立(不會交互作用)</li><li>Repeatable 可重複執行</li><li>Self-Validating 告知結果成功、失敗</li><li>Timely 應該在產品程式出來前就設計好</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="pure-function"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#pure-function" title="Direct link to heading">#</a>Pure Function</h3><ul><li>Many-to-one Function </li><li>One-to-one Function </li><li>即一個輸入只能由一個獨特的輸出</li></ul><hr><p>Demo case</p><ul><li><p><a href="https://github.com/BlueT/obj-filter">https://github.com/BlueT/obj-filter</a></p></li><li><p><a href="https://github.com/nodesource/distributions/blob/master/README.md#installation-instructions">https://github.com/nodesource/distributions/blob/master/README.md#installation-instructions</a></p></li><li><p>安裝 Node.js 10.x</p></li></ul><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-shell= codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Using Ubuntu</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sudo apt-get install -y nodejs</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><ul><li>tape: 測試套件</li><li>tap-spec: 輸出美觀化</li></ul><p>:::info
本地端執行 <code>nyc --check-coverage --reporter=lcov tape ./t/[0-9]*.test.js | tap-spec</code>
需加上 npx(利用 npm 套件執行)
<code>npx nyc --check-coverage --reporter=lcov tape ./t/[0-9]*.test.js | npx tap-spec</code>
:::</p><ul><li>sonarqube: 程式碼分析、品質測試</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor" id="linux-asynchronous"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#linux-asynchronous" title="Direct link to heading">#</a>Linux Asynchronous</h1><ul><li><p>0、Async的問題很複雜，簡單來說從Kernel層開始算-》上面封裝到事件循環（語言層）-》再封裝到架構層-》最後封裝到用戶層，這裡的用戶指的不是一般使用者而指的是web engine的開發人員，即一般俗稱的架構師.....</p><p>於是中間涉及到各種各樣樣的抽象與封裝概念，理解概念的同時另一方面還包含著實作，所以如果你曾深入研究過某種語言的異步文檔，比如你曾讀過Python的<a href="https://docs.python.org/3/library/asyncio.html">Asyncio文檔</a>，你一定會被其龐雜所震撼，期間涉及到諸如cotroutine\tasks\future\eventloop\transports\protocols等等僅限於語言層的概念(不管哪一個都沒聽過),所以为了不至迷路，在學習Async的過程中时刻保持清醒地認識到我目前正在解決哪个層面的問題是 &quot;always&quot; 有必要的。</p><h6><a aria-hidden="true" tabindex="-1" class="anchor" id="本段重點：為了介紹epoll，我們將不得不介紹一系列概念。幸運的是我們將遵循從high-level-api到low-level-api的順序，不會像網路上絕大多數自己也不懂的教學一樣讓你聽得一頭霧水。"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#本段重點：為了介紹epoll，我們將不得不介紹一系列概念。幸運的是我們將遵循從high-level-api到low-level-api的順序，不會像網路上絕大多數自己也不懂的教學一樣讓你聽得一頭霧水。" title="Direct link to heading">#</a>本段重點：為了介紹Epoll，我們將不得不介紹一系列概念。幸運的是我們將遵循從high level api到low level api的順序，不會像網路上絕大多數自己也不懂的教學一樣讓你聽得一頭霧水。</h6></li><li><p>1、因此我們首先DEMO一個高層async api，以展現其最終應用效果，如同展現CMOS最後可以做成電腦，而電腦可以用來打game一樣，讓第一次接觸的同學有一個直觀感受。</p><p>  RPC：遠程過程調用，架構於Transport Layer之上的進程間通訊協定（如果你對OSI網路通訊分層架構有了解的話）。事實上如果你希望，你可以用TCP/UDP/QUIC等任何協定傳輸層為基礎，在此基礎上建構自己的RPC協定。http封裝作為RPC調用接口基本上是不存在的，因進程間頻繁通訊，RPC協定必須高效，如果TCP有安全性問題我們更願意自己封裝一個RSA在上面也不會選擇HTTP。
</p></li></ul><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-Python codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 簡單的RPC server demo.py</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from easyrpc import *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">s = rpc_server()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@s.register_function()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def fib(n):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    a ,b = 0 ,1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    for i in range(n):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        a ,b = b ,a+b</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">s.start_serving()</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>以上代碼顯而易見地實現了，註冊RPC服務-》開始RPC服務的步驟。想要實現像偽代碼一樣優雅的代碼，是工程師們長期對Async進行研發的終極目的之二分之一（剩餘二分之一的終極目的是效能）</p><p>當你熟悉socket的異步編程特性後，你可以快速地架出這種easyrpc的框架。（這個easyrpc模組我大概做了一個小時左右。） 實現這種框架後的好處是，可以對服務進行基於網路通訊的解耦，所有你所知道的Amazing的web應用基本都是從這裡出發的。</p><p>為什麼是RPC？RPC本身作為一個古老的進程間通訊手段，概念提出很久了，技術上卻是很新的。web服務從這裡出發，大概是欣賞其更細緻的力度，相比於MessageQueue、資料庫傳遞等，在絕大多數情況下都更容易抽象業務，有種完全將業務掌握在手心的感覺。而相比於未經網路層隔離的本機通訊FileDiscripter\pipe\memoryshare相比又能避免“一人摔跤全家跌倒”————故而時至今日事實上RPC已經像空氣一般無處不在，只不過大多數人甚至沒有發覺它的存在。</p><p>當然如果你想要的話，你也可以將其封裝為HTTP服務，下列代碼也讓我們見識到python架設web server的速度是真的快：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-Python codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 簡單的RPC client demo 封裝為 http.py</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from easyrpc import *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from flask import Flask , reuqest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">app = Flask(__name__)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rpc = rpc_client()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@app.route(&#x27;/fib&#x27;) # 利用get顯式傳遞參數</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def fib():</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    input_number = int(request.args.get(&#x27;n&#x27;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return json.dumps( {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;answer&quot; : rpc.fib(input_number)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if __name__ == &quot;__main__&quot;:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    app.run(debug=False)</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>這裡我們將服務封裝為RPC，再封裝為HTTP。（當然，因為基於TCP，你也可以自己實現httpserver——如果你想要的話）。總之我們在RPC的基礎上快速地架起了一個所有語言都能通用的斐波那鍥數列服務。（類比地，比如如果你覺得python中的list.sort()非常實用且高效，你可以將其以這種方式暴露接口給java，在java中調用python的sort，非常優雅——雖然基於http並不是一種良好的暴露接口的方式）</p><p>但是，這裡出現一個問題，sort是一個常用方法，但如果我們使用<code>wrk</code>對這個服務進行壓力測試：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-undefined codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">% &gt; wrk -t8 -c200 -d10 http://127.0.0.1:5000/fib?n=1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Running 10s test @ http://127.0.0.1:5000/fib?n=1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  8 threads and 200 connections</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Latency   404.04ms   87.20ms   1.68s    92.12%</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Req/Sec    48.53     37.48   190.00     67.56%</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  3204 requests in 10.06s, 494.38KB read</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Socket errors: connect 0, read 0, write 0, timeout 11</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Requests/sec:    318.34</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Transfer/sec:     49.12KB</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>我們發現其效能異常地低，大概已經低到了不可接受的水準。使用8thread，200並發連接進行本地echo，得到平均延遲400ms，QPS約320，完全不具備部署能力。
（為了名譽我在這裡澄清一下，我們使用異步架構假設的RPC，即便是玩具，無論如何性能也是可以輕鬆超過gRPC的，本處性能低下之瓶頸在於web Engine。如果妳曾讀過Flask的代碼，你會發現其封裝非常地優雅、Pythonic，但由於並發基於線程模型——這也是我們接下來要講到的，導致了其面對大量網路I/O時吞吐效能嚴重低下）</p><h6><a aria-hidden="true" tabindex="-1" class="anchor" id="本段重點：rpc是一切web應用的基礎，幾乎所有amazing的網絡服務：分佈式雲計算、load-balancing、網路應用如fb、youtube的後端等等都基於高效的rpc模組進行微服務間通訊。雖然用起來很魔法，但把web-io的效能做高是困難的，比如我們這裡的flask就遇到了難以解決的效能瓶頸。那麼是什麼導致了這個問題呢？"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#本段重點：rpc是一切web應用的基礎，幾乎所有amazing的網絡服務：分佈式雲計算、load-balancing、網路應用如fb、youtube的後端等等都基於高效的rpc模組進行微服務間通訊。雖然用起來很魔法，但把web-io的效能做高是困難的，比如我們這裡的flask就遇到了難以解決的效能瓶頸。那麼是什麼導致了這個問題呢？" title="Direct link to heading">#</a>本段重點：RPC是一切web應用的基礎，幾乎所有amazing的網絡服務：分佈式雲計算、Load balancing、網路應用如fb、Youtube的後端等等都基於高效的RPC模組進行微服務間通訊。雖然用起來很魔法，但把web I/O的效能做高是困難的，比如我們這裡的Flask就遇到了難以解決的效能瓶頸。那麼是什麼導致了這個問題呢？</h6><h6><a aria-hidden="true" tabindex="-1" class="anchor" id="補充：如果你對開源rpc架構有興趣的話，流行的框架有grpc、brpc、thrift等等。其中以谷歌開源的grpc效能最差，故我們自己搭建asyncrpc的效能無論如何也應以超過grpc為及格標準。"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#補充：如果你對開源rpc架構有興趣的話，流行的框架有grpc、brpc、thrift等等。其中以谷歌開源的grpc效能最差，故我們自己搭建asyncrpc的效能無論如何也應以超過grpc為及格標準。" title="Direct link to heading">#</a>補充：如果你對開源RPC架構有興趣的話，流行的框架有gRPC、bRPC、thrift等等。其中以谷歌開源的gRPC效能最差，故我們自己搭建AsyncRPC的效能無論如何也應以超過grpc為及格標準。</h6><p>2、是什麼導致了網路I/O性能卡頓呢？先別急，我們慢慢來從頭實現一個RPC。過程中自然會遇到這個問題。
理所當然地，我們直觀地會想到從寫一個socket echo server開始：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-Python= codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 簡單的socket echo server.py</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from socket import *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 套接字類型有AF_INET和AF_UNIX可選，協定有SOCK_STREAM/SOCK_DGRAM可選</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock = socket(AF_INET , SOCK_STREAM)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock.setsockopt(SOL_SOCKET , SO_REUSEADDR , 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock.bind((&#x27;&#x27;,25000))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock.listen(10)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # 每當有人請求建立連接</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    client, addr = sock.accept() ; print(f&quot;Connect from {addr}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        data = client.recv(1024)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if not data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            break</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        client.sendall(b&#x27;Got &#x27; + data)</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>Python的socket programming非常簡單，如果你曾经用C进行过socket編程的話，你可能會理解這是為什麼我們喜歡用Python的其中一條原因。</p><p>運行server後，使用<code>nc localhost 25000</code>命令進行netconnection測試。可見其可以正常地回文，echo server工作正常。如果我們將回文的部分改成如下的內容：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-python= codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # 每當有人請求建立連接</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    client, addr = sock.accept() ; print(f&quot;Connect from {addr}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        data = int ( client.recv(1024) )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if not data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            break</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            a ,b = 0 ,1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            for i in range(n):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                a ,b = b ,a + b</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            client.sendall(bytes(a))</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>即向其中插入了fibonacci sequence的邏輯，就實現了一個剛剛demo過的RPC服務，例如現在在<code>nc localhost 25000</code>中輸入10，他會返回給你ascii編碼的fibonacci第十項。在此基礎上（如果你熟悉Python特性的話）再進行一系列封裝（包括異常處理等等）就能實現上文中優雅的easyrpc了。 </p><p>問題是，當前這個server版本，沒有辦法支持並發連結。例如兩個nc同時連入，只有當第一個人退出之後第二個人的服務才會啟動。顯然這是不及格的RPC服務，那麼如何解決呢？</p><p>直觀地我們想到了使用threading , 為每一個連入的用戶單獨開闢一個新線程，讓任務並行：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-Python codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 簡單的socket echo server ———— 利用threading .py</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from socket import *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from threading import Thread</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from functools import partial # 引入函數裝飾器</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock = socket(AF_INET , SOCK_STREAM)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock.setsockopt(SOL_SOCKET , SO_REUSEADDR , 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock.bind((&#x27;&#x27;,25000))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sock.listen(10)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 定義一個 request handler</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def hendler(client):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # open with context processor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    with client:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            data = client.recv(1024)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if not data: break</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            client.sendall(b&#x27;Got &#x27; + data)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # 每當有人請求建立連接</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    client, addr = sock.accept() ; print(f&quot;Connect from {addr}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # 在新線程中處理用戶的請求</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread(target = partial(handerl , client = client)).start()</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><h6><a aria-hidden="true" tabindex="-1" class="anchor" id="這樣，我們的server就可以並發地處理用戶的請求了。但其基於多線程模型，雖然我們沒有時間測試，可以想見它的效能是非常差的（有興趣的同學可以測一下它的echo-qps）。不遑說，是因為多線程模型下一些固有的，無法解決的機理導致。由於高io吞吐在當代已經是一個普及性問題出門就能撞見的程度，於是工程師們開始了長期的，對於這個問題的解決的探尋，其探尋的結果也就是async。後事如何，我們下回分解。"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#這樣，我們的server就可以並發地處理用戶的請求了。但其基於多線程模型，雖然我們沒有時間測試，可以想見它的效能是非常差的（有興趣的同學可以測一下它的echo-qps）。不遑說，是因為多線程模型下一些固有的，無法解決的機理導致。由於高io吞吐在當代已經是一個普及性問題出門就能撞見的程度，於是工程師們開始了長期的，對於這個問題的解決的探尋，其探尋的結果也就是async。後事如何，我們下回分解。" title="Direct link to heading">#</a>這樣，我們的server就可以並發地處理用戶的請求了。但其基於多線程模型，雖然我們沒有時間測試，可以想見它的效能是非常差的（有興趣的同學可以測一下它的echo qps）。不遑說，是因為多線程模型下一些固有的，無法解決的機理導致。由於高I/O吞吐在當代已經是一個普及性問題——出門就能撞見的程度，於是工程師們開始了長期的，對於這個問題的解決的探尋，其探尋的結果也就是Async。後事如何，我們下回分解。</h6><h6><a aria-hidden="true" tabindex="-1" class="anchor" id="課後與老師討論的趣聞，補充一段歷史：async-，-thread-，-gil-以及python的愛恨情仇"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#課後與老師討論的趣聞，補充一段歷史：async-，-thread-，-gil-以及python的愛恨情仇" title="Direct link to heading">#</a>#課後與老師討論的趣聞，補充一段歷史：async ， thread ， GIL 以及python的愛恨情仇</h6><blockquote><p>“業餘程序員”Guido，在1991年開發Python，在1993年為其加入thread模組（后面在py3中被封裝程度更高的threading所取代），旨在解決並行I/O問題。同時為了解決線程間的資源競爭問題，引入了大名鼎鼎的GIL——global interpreter lock（全局解釋鎖），使得Python可以取得多個系統級線程（他們不是偽造的線程，而是真正的系統級線程），但同一時間只有一個thread可以被解釋，除非發生I/O或C的調用，GIL才會被釋放——這導致了Python雖然在語言層面支持多線程，卻不能通過這點利用CPU多核心的優勢。</p><p>這種設計在當年是沒什麼問題的（畢竟當年超過2核心的電腦幾乎不存在）————並且雖然廣受新手程序員詬病，直到今天也不能說這是一個不好的設計：如果你看過GIL的源碼，它非常非常單純，它可以輕易地讓你的程式跑的很快（快好幾倍，下文會解釋），並且永遠不會產生死鎖等等多線程競爭資源產生的問題——因為只有一把鎖。</p><p>可見，當初thread被引入python，目的就只是為了解決I/O密集型任務（至於運算密集型任務，Python中真正利用多核心的模組是multiprocessing ， 這個模組在即將發佈的3.8版本中有重大改進）。但是理所當然地，如果我們的報告主題要繼續講下去的話，代表它不是一個良好的解決方案——因為stackspace、因為usermode到kernelmode的切換、因為搶占式任務導致的算力浪費、等等。因而這個問題也成為Guido長期考慮的一個問題——這種思考一直持續了20年。直到python3.4中asyncio被加入標準庫，3.5版本中引入async/await關鍵字，python3.6更新後（約2016年）aysncio才成為一個工程可用級別的庫。代表著這個長達20年的問題的正式解決。</p><p>事實上直到今天，多核心電腦橫行的2019年，越來越多人覺得python不能利用多核心性能是非常遺憾的（事實上我們可以用，python社區已經有移除GIL的版本：<a href="https://lwn.net/">gilectomy</a>以及<a href="http://doc.pypy.org/en/latest/stm.html">pypy的stm版本</a>，保持Capi的基礎上，將大鎖拆分成無數個用戶級小鎖，其代價也並不高，只是比普通版本慢三倍而已，笑）。</p><p>如果要問今天Python最大的核心財富是什麼，一個基本共識是一大票世界各地一流高校的科研人員，使用Python開發出了各種易用的科學計算庫，通用且高效，使Python成為科研語言的NO1，而且是唯一，生態繁榮度可以跟Java一較高下的語言（這些也使python可以乘上machine learning的東風）。科研人員為什麼選擇Python？因為非CS專業的研究者喜歡Python同時兼具優雅和強大表達能力的語法————作為語言開發唯一負責人“目光短淺”的Guido的指揮下Python形成了分散的社區，各個核心開發者各自為戰，因而python2在升級為3時並沒有足夠魄力移除GIL，或是為解釋器加入JIT功能。但也正因如此，個人能力有限，唯一能做出貢獻的方式就是修改一些語法————使得PEP中提到的幾乎都是絞盡腦汁想到的語法上的改進，使得Python幾乎成為所有程式語言裡抽象能力最強的，從而得到了科研人員們的青睞。</p><p>另一點原因是，由於GIL的存在，使得python調用C語言的api異常簡單，用戶層不用考慮多線程複雜的鎖問題————這幾乎是非CS出身科研人員能駕馭的極限。</p><p>各自為戰的社區、簡單的GIL，幾乎是python今天所有令人詬病原因的起因————不能利用多核心（事實上可以，否則Python在DL中的廣泛使用也不會存在，只不過需要訴諸於C，在記憶體共享上沒有那麼直觀，導致它的開發API實際是不友好的）、語言效能差等等。但也正因如此，為Python積累了今日的核心財富，導致近幾年來Python使用率屢創新高。</p><p>26年後的今天會是這樣一番局面，恐怕也是1993年的Guido寫下GIL的那几行代码時所沒有想到的吧。</p></blockquote><p><a href="https://docs.google.com/presentation/d/1F1HsznO5RkjQJmn3pF7Bm22Kch_h5h54fPbRZCr7BNY/edit?usp=sharing">https://docs.google.com/presentation/d/1F1HsznO5RkjQJmn3pF7Bm22Kch_h5h54fPbRZCr7BNY/edit?usp=sharing</a></p><ul><li>busy loop<ul><li>一直while loop</li></ul></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="demo一个纯python实现的事件循环socketserver代码-，-事件循环写在上面，业务代码写在下面"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#demo一个纯python实现的事件循环socketserver代码-，-事件循环写在上面，业务代码写在下面" title="Direct link to heading">#</a>Demo一个纯Python实现的事件循环+socketserver代码 ， 事件循环写在上面，业务代码写在下面</h4><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-Python codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">from collections import deque</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from selectors import EpollSelector , EVENT_READ , EVENT_WRITE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from asyncio import coroutine</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from socket import *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import asyncio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@coroutine</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def wait_read(sock):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    yield &#x27;read_wait&#x27; , sock</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@coroutine</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def wait_write(sock):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    yield &#x27;write_wait&#x27; , sock</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class PlayLoop(object):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;&quot;&quot;docstring for PlayLoop&quot;&quot;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def __init__(self):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        super(PlayLoop, self).__init__()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self._prepare_to_run = deque()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self._selector = EpollSelector()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    async def sock_accept(self , sock):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await wait_read(sock)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return sock.accept()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    async def sock_recv(self , sock , MaximumBytes):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await wait_read(sock)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return sock.recv(MaximumBytes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    async def sock_sendall(self , sock , data):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        while data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            await wait_write(sock)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            num = sock.send(data)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            data = data[num:]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def create_task(self, coro):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self._prepare_to_run.append(coro)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def run_forever(self):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            while not self._prepare_to_run:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                events = self._selector.select()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                for key, _ in events:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    # if a cotoutine (key.data which was registered in self.write_wait) was redy to run , it should be append to runlist but poped off from kernel watching list.  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    # by contrary if a coroutine is appended to kernel watching list ,it should be poped off from loop.runlist   </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    self._prepare_to_run.append(key.data)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    # key.fileobj == a python data structure which could be understood as representing a file discriptor.  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    self._selector.unregister(key.fileobj)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            while self._prepare_to_run:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                self.current_task = self._prepare_to_run.popleft()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                try:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    # you cannot use next to triger a coroutine ,but use send for the same behabior</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    op ,*args = self.current_task.send(None) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    # here&#x27;s a little bit tricky way to get self.write_wait / self.read_wait to register specify coroutine</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    getattr(self , op)(*args)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                except StopIteration:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    pass</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def write_wait(self , sock):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self._selector.register(sock , EVENT_WRITE , self.current_task)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def read_wait(self , sock):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self._selector.register(sock , EVENT_READ , self.current_task)  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">defination of playloop class above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">running code below</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">maybe you can decoupling them into two files ,like test.py and playloop.py</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">and then &#x27;from playloop import PlayLoop&#x27; in test.py</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">async def handler(loop, client):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    with client:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            data = await loop.sock_recv(client, 64) # client.recv()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if not data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                break</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            print(f&quot;\nIncomming messgae : {data}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            back = b&quot;Got &quot; + data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            await loop.sock_sendall(client,back)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            print(f&quot;Sent back message : {back}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">async def main(loop):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sock = socket(AF_INET , SOCK_STREAM)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sock.setsockopt(SOL_SOCKET , SO_REUSEADDR , 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sock.bind((&#x27;&#x27;,25000))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sock.listen()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sock.setblocking(False)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    print(f&quot;Socket serving at {sock.getsockname()}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while True:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        client ,addr = await loop.sock_accept(sock)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        loop.create_task(handler(loop,client))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">thanks for pluggable eventloop design in python async library , there&#x27;s chances you can try different types of event loop and then maybe benchmark thier performance respectively</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">you can try asycnio.loop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">or you can try our Playloop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">or you can use loop from uvloop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(use `pip install uvloop` to get started)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># import uvloop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># loop = asyncio.get_event_loop()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">loop = PlayLoop()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">loop.create_task(main(loop))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">loop.run_forever()</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="libevent-ppt"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#libevent-ppt" title="Direct link to heading">#</a>libevent PPT</h3><p><a href="https://docs.google.com/presentation/d/1GNsCx5-7F7KcgB-dmqh0wCvlq3-6KN3Rt1F_eeWtBlo/edit#slide=id.p">https://docs.google.com/presentation/d/1GNsCx5-7F7KcgB-dmqh0wCvlq3-6KN3Rt1F_eeWtBlo/edit#slide=id.p</a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/NCNU-OpenSource/NCNU-OpenSource.github.io/edit/src/docs/1072/Week15.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/1072/Week14"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« Week14</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/1072/Week18"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Week18 »</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#node-js" class="contents__link">Node js</a></li><li><a href="#vs-code" class="contents__link">VS Code</a></li><li><a href="#tdd-test-driven-development" class="contents__link">TDD (Test-Driven Development)</a></li><li><a href="#bdd-behavior-driven-development" class="contents__link">BDD (Behavior Driven Development)</a></li><li><a href="#first-rules" class="contents__link">FIRST Rules</a></li><li><a href="#pure-function" class="contents__link">Pure Function</a></li><li><a href="#libevent-ppt" class="contents__link">libevent PPT</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Related Links</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/readme">Notes</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://blog.moli.rocks/">Blog</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/groups/NCNU.OpenSource/">Facebook</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/NCNU-OpenSource/">GitHub</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://t.me/MOLi_rocks">Telegram</a></li></ul></div></div><div class="text--center">Copyright © NCNU OpenSource BY-SA 4.0. Built with Docusaurus.</div></div></footer>
</div>

<script src="/styles.7d182436.js"></script>

<script src="/runtime~main.e41f265a.js"></script>

<script src="/main.e456ea51.js"></script>

<script src="/1.dbe55609.js"></script>

<script src="/106.8c98c43f.js"></script>

<script src="/20ac7829.b7570378.js"></script>

<script src="/17896441.60943779.js"></script>

<script src="/cc443558.0248b118.js"></script>


</body>
</html>