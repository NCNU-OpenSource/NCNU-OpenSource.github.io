(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{172:function(t,e,n){"use strict";n.r(e),n.d(e,"frontMatter",(function(){return a})),n.d(e,"metadata",(function(){return i})),n.d(e,"rightToc",(function(){return o})),n.d(e,"default",(function(){return c}));var p=n(1),s=n(9),r=(n(0),n(233)),a={},i={id:"1071/Week12",title:"Week12",description:"# Week12, 12/6 LSA",source:"@site/docs/1071/Week12.md",permalink:"/docs/1071/Week12",editUrl:"https://github.com/NCNU-OpenSource/NCNU-OpenSource.github.io/edit/src/docs/1071/Week12.md",sidebar:"someSidebar",previous:{title:"Week11",permalink:"/docs/1071/Week11"},next:{title:"Week13",permalink:"/docs/1071/Week13"}},o=[{value:"Midterm Conf",id:"midterm-conf",children:[]}],l={rightToc:o};function c(t){var e=t.components,n=Object(s.a)(t,["components"]);return Object(r.b)("wrapper",Object(p.a)({},l,n,{components:e,mdxType:"MDXLayout"}),Object(r.b)("h1",{id:"week12-126-lsa"},"Week12, 12/6 LSA"),Object(r.b)("p",null,"===="),Object(r.b)("p",null,Object(r.b)("img",Object(p.a)({parentName:"p"},{src:"https://i.imgur.com/QN3Xi1z.png",alt:null}))),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"NAT VM\u7684\u7db2\u7d61\u5728\u672c\u6a5f(\u81ea\u5df1\u7684\u96fb\u8166)\u7684\u5f8c\u9762"),Object(r.b)("li",{parentName:"ul"},"bridge VM\u7684\u7db2\u7d61\u6703\u8ddf\u672c\u6a5f\u7684\u7db2\u8def\u540c\u5c64")),Object(r.b)("p",null,"\u5982\u679c\u62ff\u4e0d\u5230ip (bridge)\n:::warning\n",Object(r.b)("inlineCode",{parentName:"p"},"/etc/network/interfaces")),Object(r.b)("p",null,"auto <\u7db2\u5361\u540d\u7a31>\niface <\u7db2\u5361\u540d\u7a31> inet dhcp"),Object(r.b)("p",null,":::"),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"sudo ifup <\u7db2\u5361\u540d\u7a31>")),Object(r.b)("p",null,"\u6709\u95dc SNAT / DNAT / MASQUERADE \u7684\u611b\u6068\u60c5\u6101\uff0c\u8acb\u53c3\u8003\u9019\u5169\u7bc7\u6587\u7ae0\uff1a"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(p.a)({parentName:"li"},{href:"https://read-and-thinking.blogspot.com/2009/06/iptablessnatmasquerade.html"}),"https://read-and-thinking.blogspot.com/2009/06/iptablessnatmasquerade.html")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(p.a)({parentName:"li"},{href:"http://linux.vbird.org/linux_server/0250simple_firewall.php#nat_what"}),"http://linux.vbird.org/linux_server/0250simple_firewall.php#nat_what"))),Object(r.b)("hr",null),Object(r.b)("p",null,"\u53bb\u5e74\u8003\u8a66\u7684\u5927\u6284\uff08\u984c\u76ee\u985e\u4f3c\u4f46\u4e0d\u540c\uff09\n",Object(r.b)("img",Object(p.a)({parentName:"p"},{src:"https://i.imgur.com/sQ5Uzvd.png",alt:"iptables chain flow"}))),Object(r.b)("h1",{id:"iptables"},"IPtables"),Object(r.b)("pre",null,Object(r.b)("code",Object(p.a)({parentName:"pre"},{}),'\u4f60\u4e5f\u53ef\u4ee5\u5beb\u5230\u8a2d\u5b9a\u6a94\uff0c\u8b93\u4e0b\u6b21\u958b\u6a5f\u7e7c\u7e8c\u7576router\u3002\n/etc/sysctl.conf:\nnet.ipv4.ip_forward = 1                          # \u628aip forward\u529f\u80fd\u6253\u958b\nsysctl -p /etc/sysctl.conf                       # \u4f7f\u8a2d\u5b9a\u6a94\u751f\u6548\n\n\n\n#sudo sh ip.sh\n#Environment : \n#BBI ->(enp0s3)) U1 (enp0s8)[samba/nginx/ssh:2200]-> U2[FTP/drupal/ssh:22]\n\n#\u6e05\u9664\u6240\u6709\u898f\u5247\niptables -F\niptables -X\niptables -F -t mangle\niptables -t mangle -X\niptables -F -t nat\niptables -t nat -X\n#\u8a2d\u5b9a\u653f\u7b56\niptables -P INPUT DROP\niptables -P OUTPUT ACCEPT\niptables -P FORWARD ACCEPT\n#\u4fe1\u4efb\u672c\u6a5f\niptables -A INPUT -i lo -j ACCEPT\n#\u672c\u6a5f\u5411\u5916\u5c01\u5305\u53ef\u4ee5\u56de\u5bb6\niptables -A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT\n#BBI can ssh to U1\niptables -A INPUT -i enp0s3 -p tcp -d 10.105.21.213 --dport 22 -j ACCEPT\n#samba\n#port 445 is for Windows\niptables -A INPUT -i enp0s3 -p tcp -d 10.105.21.213 --dport 139 -j ACCEPT\niptables -A INPUT -i enp0s3 -p tcp -d 10.105.21.213 --dport 445 -j ACCEPT\n#BBI\u53ef\u9023nginx\niptables -t nat -A PREROUTING -i enp0s3 -p tcp -d 10.32.20.68 --dport 80 -j DNAT --to-destination 10.0.2.15:80\niptables \n#FTP server\niptables -t nat -A PREROUTING -i enp0s3 -p tcp -d 10.32.20.68 --dport 21 -j DNAT --to-destination 10.0.2.15:21\niptalbles -A OUTPUT -o enp0s3 -j ACCEPT\n#\u7db2\u5916\u53efssh\u9032U2\niptables -t nat -A PREROUTING -i enp0s3 -p tcp -d 10.32.20.68 --dport 2200 -j DNAT --to-destination 10.0.2.15:22\niptables -t nat -A POSTROUTING -d 10.0.2.15 -o enp0s8 -j MASQUERADE\n\n#FTP\niptables -t nat -A PREROUTING -i enp0s3 -p tcp -d 10.21.20.68 --dport 80 -j DNAT --to-destination 10.0.2.15:80\n\n#\u5077\u770b filter table\necho ""\necho"=======================filter============================"\necho ""\niptables -L -n\n#\u5077\u770b nat table\necho ""\necho"========================nat=========================="\necho ""\niptables -t nat -L -n\n\n\n\n\n\u7c21\u5316 ssh \u9023\u7dda\n$ vim .ssh/config\nHOST u1\n  HostName 10.21.20.128\n  User JackKuo\n  port 3389\nHOST u2\n  HostName 163.22.17.229\n  User admin\n  port 22\n')),Object(r.b)("h2",{id:"midterm-conf"},"Midterm Conf"),Object(r.b)("pre",null,Object(r.b)("code",Object(p.a)({parentName:"pre"},{}),"U1 IP: 10.105.11.176 10.0.2.11 10.0.3.8\nU2 IP: 10.0.2.9\nU3 IP : 10.0.2.10\nU4 : 10.0.3.9\n\n\n\n#\u6240\u6709\u8a2d\u5099\u90fd\u9700\u8981\u7684\n\n#\u6e05\u9664\u6240\u6709\u898f\u5247\niptables -F\niptables -X\niptables -F -t mangle\niptables -t mangle -X\niptables -F -t nat\niptables -t nat -X\niptables -P INPUT ACCEPT\niptables -P OUTPUT ACCEPT\niptables -P FORWARD ACCEPT\n\n#\u8a2d\u5b9a\u653f\u7b56\n#:FORWARD ACCEPT [0:0]\niptables -P INPUT DROP\niptables -P OUTPUT ACCEPT\niptables -P FORWARD ACCEPT\n\n#\u4fe1\u4efb\u672c\u6a5f\niptables -A INPUT -i lo -j ACCEPT\niptables -A OUTPUT -o enp0s3 -j ACCEPT\n#\u672c\u6a5f\u5411\u5916\u5c01\u5305\u53ef\u4ee5\u56de\u5bb6\niptables -A INPUT -i enp0s3 -m state --state RELATED,ESTABLISHED -j ACCEPTev lo\n\nU1:\n# ssh only from u3 ##############\niptables -A INPUT -i enp0s8  -p tcp -s 10.0.2.10 -d 10.0.2.11 --dport 22 -j ACCEPT\n# port forward 2222->u3 22\niptables -t nat -A PREROUTING -i enp0s3 -p tcp -d 10.105.11.176 --dport 2222 -j DNAT --to-destination 10.0.2.10:22\niptables -t nat -A POSTROUTING -s 10.105.11.176 -d 10.0.2.10 -o enp0s8 -j MASQUERADE\n# port 20, 21 to u2 ftp\niptables -t nat -A PREROUTING -i enp0s3 -p tcp -d 10.105.11.176 --dport 20 -j DNAT --to-destination 10.0.2.9:20\niptables -t nat -A PREROUTING -i enp0s3 -p tcp -d 10.105.11.176 --dport 21 -j DNAT --to-destination 10.0.2.9:21\niptables -t nat -A POSTROUTING -s 10.105.11.176 -d 10.0.2.9 -o enp0s8 -j MASQUERADE\n# accept all from u3\niptables -A INPUT -i enp0s8 -s 10.0.2.10 -j ACCEPT\n# accept all from u4\niptables -A INPUT -i enp0s9 -s 10.0.3.9 -j ACCEPT\n\nU2\n# route to 10.0.3.0\nroute add -net 10.0.3.0 netmask 255.255.255.0 gw 10.0.2.11 dev enp0s8\n# ssh only from U3\niptables -A INPUT -i enp0s3 -p tcp -d 10.0.2.9 -s 10.0.2.10 --dport 22 -j ACCEPT\n# ftp\niptables -A INPUT -i enp0s3 -p tcp -s any/0 -d 10.0.2.9 --dport 20 -j ACCEPT\niptables -A INPUT -i enp0s3 -p tcp -s any/0 -d 10.0.2.9 --dport 21 -j ACCEPT\niptables -A INPUT -i enp0s3 -p tcp -s any/0 -d 10.0.2.9 --dport 80 -j ACCEPT\n# accept all from U4\niptables -A INPUT -i enp0s3 -s 10.0.3.9 -j ACCEPT\n\nU3\n# route to 10.0.3.0\nroute add -net 10.0.3.0 netmask 255.255.255.0 gw 10.0.2.11 dev enp0s8\n# smb from U4\n#iptables -A INPUT -i enp0s8 -p udp -s 10.0.3.9 -d 10.0.2.10 --dport 137 -j ACCEPT\n#iptables -A INPUT -i enp0s8 -p udp -s 10.0.3.9 -d 10.0.2.10 --dport 138 -j ACCEPT\n#iptables -A INPUT -i enp0s8 -p tcp -s 10.0.3.9 -d 10.0.2.10 --dport 139 -j ACCEPT\n#iptables -A INPUT -i enp0s8 -p tcp -s 10.0.3.9 -d 10.0.2.10 --dport 445 -j ACCEPT\n# ssh from U1\niptables -A INPUT -i enp0s8 -p tcp -s any/0 -d 10.0.2.10 --dport 22 -j ACCEPT\n# ssh to U1\niptables -A INPUT -i enp0s8 -p tcp ! --syn -s 10.0.2.10 --sport 22 -d 10.0.2.6 --dport 1024:65535 -j ACCEPT\n# ssh to U2\niptables -A INPUT -i enp0s8 -p tcp ! --syn -s 10.0.2.9 --sport 22 -d 10.0.2.6 --dport 1024:65535 -j ACCEPT\n# accept all from U4\niptables -A INPUT -i enp0s8 -s 10.0.3.4 -j ACCEPT\n\nU4\n# route to 10.0.2.0\nroute add -net 10.0.2.0 netmask 255.255.255.0 gw 10.0.3.8 dev enp0s3\n# ssh only from u3\niptables -A INPUT -i enp0s3 -p tcp -s 10.0.2.10 -d 10.0.3.9 --dport 22 -j ACCEPT\n# ssh to U1\niptables -A INPUT -i enp0s3 -p tcp ! --syn -s 10.0.2.11 --sport 22 -d 10.0.3.9 --dport 1024:65535 -j ACCEPT\n# ssh to U2\niptables -A INPUT -i enp0s3 -p tcp ! --syn -s 10.0.2.9 --sport 22 -d 10.0.3.9 --dport 1024:65535 -j ACCEPT\n# ssh to U3\niptables -A INPUT -i enp0s3 -p tcp ! --syn -s 10.0.2.10 --sport 22 -d 10.0.3.9 --dport 1024:65535 -j ACCEPT\n# smb to U3\niptables -A INPUT -i enp0s3 -p udp -s 10.0.2.10 --sport 137:138 -d 10.0.3.9 --dport 1024:65535 -j ACCEPT\niptables -A INPUT -i enp0s3 -p tcp ! --syn -s 10.0.2.10 --sport 139 -d 10.0.3.9 --dport 1024:65535 -j ACCEPT\niptables -A INPUT -i enp0s3 -p tcp ! --syn -s 10.0.2.10 --sport 445 -d 10.0.3.9 --dport 1024:65535 -j ACCEPT\n\n\n\n\u53ef\u80fd\u6703\u7528\u5230\u7684\u6307\u4ee4\nsudo ip route change default via 192.168.1.1 dev eth0\niptables\n\u7528 dmesg | grep eth \u627e\u51fa\u7db2\u5361\n")))}c.isMDXComponent=!0},233:function(t,e,n){"use strict";n.d(e,"a",(function(){return b})),n.d(e,"b",(function(){return u}));var p=n(0),s=n.n(p);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(t);e&&(p=p.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,p)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?a(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,p,s=function(t,e){if(null==t)return{};var n,p,s={},r=Object.keys(t);for(p=0;p<r.length;p++)n=r[p],e.indexOf(n)>=0||(s[n]=t[n]);return s}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(p=0;p<r.length;p++)n=r[p],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(s[n]=t[n])}return s}var l=s.a.createContext({}),c=function(t){var e=s.a.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):i({},e,{},t)),n},b=function(t){var e=c(t.components);return s.a.createElement(l.Provider,{value:e},t.children)},d={inlineCode:"code",wrapper:function(t){var e=t.children;return s.a.createElement(s.a.Fragment,{},e)}},T=Object(p.forwardRef)((function(t,e){var n=t.components,p=t.mdxType,r=t.originalType,a=t.parentName,l=o(t,["components","mdxType","originalType","parentName"]),b=c(n),T=p,u=b["".concat(a,".").concat(T)]||b[T]||d[T]||r;return n?s.a.createElement(u,i({ref:e},l,{components:n})):s.a.createElement(u,i({ref:e},l))}));function u(t,e){var n=arguments,p=e&&e.mdxType;if("string"==typeof t||p){var r=n.length,a=new Array(r);a[0]=T;var i={};for(var o in e)hasOwnProperty.call(e,o)&&(i[o]=e[o]);i.originalType=t,i.mdxType="string"==typeof t?t:p,a[1]=i;for(var l=2;l<r;l++)a[l]=n[l];return s.a.createElement.apply(null,a)}return s.a.createElement.apply(null,n)}T.displayName="MDXCreateElement"}}]);