(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{147:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return l})),t.d(n,"rightToc",(function(){return b})),t.d(n,"default",(function(){return i}));var r=t(1),a=t(9),c=(t(0),t(233)),o={},l={id:"1062/Week-13",title:"Week-13",description:"##### tags:`ncnu` `lsa`",source:"@site/docs/1062/Week-13.md",permalink:"/docs/1062/Week-13",editUrl:"https://github.com/NCNU-OpenSource/NCNU-OpenSource.github.io/edit/src/docs/1062/Week-13.md",sidebar:"someSidebar",previous:{title:"Week-12",permalink:"/docs/1062/Week-12"},next:{title:"Week-14",permalink:"/docs/1062/Week-14"}},b=[{value:"\u5b89\u88ddhaproxy",id:"\u5b89\u88ddhaproxy",children:[]},{value:"\u67e5\u770b\u7248\u672c",id:"\u67e5\u770b\u7248\u672c",children:[]},{value:"\u67e5\u770b\u8a2d\u5b9a\u6a94",id:"\u67e5\u770b\u8a2d\u5b9a\u6a94",children:[]},{value:"\u7de8\u8f2f\u8a2d\u5b9a\u6587\u4ef6",id:"\u7de8\u8f2f\u8a2d\u5b9a\u6587\u4ef6",children:[]},{value:"\u555f\u7528\u670d\u52d9",id:"\u555f\u7528\u670d\u52d9",children:[]},{value:"\u5728\u4e0d\u4fee\u6539\u539f\u59cb\u8a2d\u5b9a\u6a94\u7684\u72c0\u614b\u4e0b\uff0c\u4f7f\u7528\u53e6\u4e00\u500b\u8a2d\u5b9a\uff1a",id:"\u5728\u4e0d\u4fee\u6539\u539f\u59cb\u8a2d\u5b9a\u6a94\u7684\u72c0\u614b\u4e0b\uff0c\u4f7f\u7528\u53e6\u4e00\u500b\u8a2d\u5b9a\uff1a",children:[]},{value:"MariaDB 10.1 \u5b89\u88dd",id:"mariadb-101-\u5b89\u88dd",children:[{value:"\u5982\u679c\u51fa\u73feError Message (plugin unix_socket is not loaded...)",id:"\u5982\u679c\u51fa\u73feerror-message-plugin-unix_socket-is-not-loaded",children:[]},{value:"Cluster \u8a2d\u5b9a",id:"cluster-\u8a2d\u5b9a",children:[]}]}],s={rightToc:b};function i(e){var n=e.components,t=Object(a.a)(e,["components"]);return Object(c.b)("wrapper",Object(r.a)({},s,t,{components:n,mdxType:"MDXLayout"}),Object(c.b)("h5",{id:"tagsncnu-lsa"},"tags:",Object(c.b)("inlineCode",{parentName:"h5"},"ncnu")," ",Object(c.b)("inlineCode",{parentName:"h5"},"lsa")),Object(c.b)("p",null,"how to disable ipv6 ?\n",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.ubuntu-tw.org/modules/newbb/viewtopic.php?post_id=190590"}),"https://www.ubuntu-tw.org/modules/newbb/viewtopic.php?post_id=190590")),Object(c.b)("p",null,"\u5982\u679c\u5927\u5bb6VM\u88e1\u9762\uff0c\u7db2\u8def\u9023\u4e0d\u4e0a\u7684\u8a71\uff08\uff08\u6b61\u8fce\u4f86\u9019\u88e1\uff0c\u63a8\u63a8\n(",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://geeky.name/content/disable-ipv6-support-ubuntulinux"}),"https://geeky.name/content/disable-ipv6-support-ubuntulinux"),")"),Object(c.b)("h1",{id:"haproxy--mariadb-cluster"},"Haproxy & MariaDB Cluster"),Object(c.b)("h3",{id:"\u5b89\u88ddhaproxy"},"\u5b89\u88ddhaproxy"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"sudo apt install haproxy")),Object(c.b)("h3",{id:"\u67e5\u770b\u7248\u672c"},"\u67e5\u770b\u7248\u672c"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"$ haproxy -v")),Object(c.b)("h3",{id:"\u67e5\u770b\u8a2d\u5b9a\u6a94"},"\u67e5\u770b\u8a2d\u5b9a\u6a94"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"$ cat /etc/haproxy/haproxy.cfg")),Object(c.b)("h3",{id:"\u7de8\u8f2f\u8a2d\u5b9a\u6587\u4ef6"},"\u7de8\u8f2f\u8a2d\u5b9a\u6587\u4ef6"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"$ sudo nano /etc/haproxy/haproxy.cfg")),Object(c.b)("h4",{id:"\u767b\u5165-admin-\u754c\u9762\u8a2d\u5b9a\u6a94"},"\u767b\u5165 admin \u754c\u9762\u8a2d\u5b9a\u6a94"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"listen admin_stats\n    bind 0.0.0.0:9999\n    stats refresh 30s\n    stats uri /\n    stats realm Haproxy Manager\n    stats auth admin:admin\n    stats hide-version\n")),Object(c.b)("h4",{id:"load-balance"},"Load Balance"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"listen http-in\n    bind *:8888\n    server server1 10.0.2.5:80 maxconn 32\n    server server2 127.0.0.1:8080 maxconn 32\n")),Object(c.b)("h4",{id:"load-balance-\u8a2d\u5b9a\u6a94\u7684\u53e6\u4e00\u7a2e\u5beb\u6cd5"},"Load Balance \u8a2d\u5b9a\u6a94\u7684\u53e6\u4e00\u7a2e\u5beb\u6cd5"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"frontend http-in\n    bind *:9900\n    default_backend group1\n\nbackend group1\n    mode http\n    server server1 10.0.2.5:80 check\n")),Object(c.b)("h3",{id:"\u555f\u7528\u670d\u52d9"},"\u555f\u7528\u670d\u52d9"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"$ sudo service haproxy start")),Object(c.b)("h3",{id:"\u5728\u4e0d\u4fee\u6539\u539f\u59cb\u8a2d\u5b9a\u6a94\u7684\u72c0\u614b\u4e0b\uff0c\u4f7f\u7528\u53e6\u4e00\u500b\u8a2d\u5b9a\uff1a"},"\u5728\u4e0d\u4fee\u6539\u539f\u59cb\u8a2d\u5b9a\u6a94\u7684\u72c0\u614b\u4e0b\uff0c\u4f7f\u7528\u53e6\u4e00\u500b\u8a2d\u5b9a\uff1a"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell="}),"$ mkdir haproxy\n$ cd haproxy\n$ nano website.cfg\n")),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"global\n    daemon\n    maxconn 256\n\ndefaults\n    mode http\n    timeout connect 3000ms\n    timeout client 3000ms\n    timeout server 3000ms\n\nlisten http-in\n    bind *:8888\n    server server1 127.0.0.1:8080 maxconn 32\n    server server2 127.0.0.1:8080 maxconn 32\n\nlisten admin_stats\n    bind 0.0.0.0:9999\n    stats refresh 30s\n    stats uri /\n    stats realm Haproxy Manager\n    stats auth admin:admin\n    #stats hide-version\n")),Object(c.b)("p",null,"\u57f7\u884c\uff08\u9808\u5148stop\u539f\u670d\u52d9\uff09\n",Object(c.b)("inlineCode",{parentName:"p"},"$ haproxy -f website.cfg")),Object(c.b)("h2",{id:"mariadb-101-\u5b89\u88dd"},"MariaDB 10.1 \u5b89\u88dd"),Object(c.b)("p",null,"\u4e5f\u53ef\u4ee5\u5230\u9019\u88e1\u9078\u64c7\u9069\u5408\u7684\u4f86\u6e90 ",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://downloads.mariadb.org/mariadb/repositories/"}),"https://downloads.mariadb.org/mariadb/repositories/"),"\n",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.howtoforge.com/tutorial/how-to-install-and-configure-galera-cluster-on-ubuntu-1604/"}),"https://www.howtoforge.com/tutorial/how-to-install-and-configure-galera-cluster-on-ubuntu-1604/")),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell="}),"sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8\n\nsudo sh -c \"echo 'deb https://mirrors.evowise.com/mariadb/repo/10.1/ubuntu '$(lsb_release -cs)' main' > /etc/apt/sources.list.d/MariaDB101.list\"\n\nsudo apt update\n\nsudo apt install mariadb-server mariadb-client \n\nsudo apt install socat rsync\n\nsudo mysql -u root -p\n\nGRANT ALL ON *.* TO `root`@`%` IDENTIFIED BY \"rootpwd\";\nFLUSH PRIVILEGES;\n")),Object(c.b)("h3",{id:"\u5982\u679c\u51fa\u73feerror-message-plugin-unix_socket-is-not-loaded"},"\u5982\u679c\u51fa\u73feError Message (plugin unix_socket is not loaded...)"),Object(c.b)("p",null,"\u5728\n",Object(c.b)("inlineCode",{parentName:"p"},"/etc/mysql/mariadb.conf.d/50-server.cnf"),"\n\u6216\u662f\n",Object(c.b)("inlineCode",{parentName:"p"},"/etc/mysql/my.cnf"),"\n\u6216\u662f\n",Object(c.b)("inlineCode",{parentName:"p"},"/etc/my.cnf"),"\n\u7684 ","[mysqld]"," section \u4e2d\u52a0\u5165"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"plugin-load-add = auth_socket.so\n")),Object(c.b)("h3",{id:"cluster-\u8a2d\u5b9a"},"Cluster \u8a2d\u5b9a"),Object(c.b)("p",null,"(\u65b0\u589e\u4e00\u8a2d\u5b9a\u6a94)\n",Object(c.b)("inlineCode",{parentName:"p"},"$ sudo nano /etc/mysql/conf.d/galera.cnf")),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"[mysqld]\nbinlog_format=ROW\nbind-address=0.0.0.0\n\nwsrep_on=ON\nwsrep_provider=/usr/lib/galera/libgalera_smm.so\n\nwsrep_cluster_name='test_cluster'\nwsrep_cluster_address='gcomm://'\n\nwsrep_node_name='db1'\nwsrep_sst_auth=root:rootpwd\nwsrep_sst_method=rsync\n")),Object(c.b)("p",null,"\u53e2\u96c6\u4e2d\u7b2c\u4e00\u53f0\u555f\u7528\u6642\u6240\u7528\u7684\u6307\u4ee4\n",Object(c.b)("inlineCode",{parentName:"p"},"$ sudo galera_new_cluster")),Object(c.b)("p",null,"\u5176\u9918\u555f\u7528\u7684\u6307\u4ee4\n",Object(c.b)("inlineCode",{parentName:"p"},"$ sudo service mysql start")),Object(c.b)("p",null,"\u6aa2\u67e5 galera cluster\n",Object(c.b)("inlineCode",{parentName:"p"},"$ mysql -u root -p -e \"SHOW STATUS LIKE 'wsrep_%'; \" ")),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"$ sudo mysql -u root -p -e \"SHOW STATUS LIKE 'wsrep_cluster_size'; \" ")),Object(c.b)("p",null,"\u9060\u7aef\u9023\u7dda\n",Object(c.b)("inlineCode",{parentName:"p"},"$ sudo mysql -u root -p -h 10.0.2.7 -P 3306")),Object(c.b)("p",null,"Cluster Check:\n",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/olafz/percona-clustercheck"}),"https://github.com/olafz/percona-clustercheck")),Object(c.b)("p",null,"git clone ",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/olafz/percona-clustercheck"}),"https://github.com/olafz/percona-clustercheck")),Object(c.b)("p",null,"sudo mv clustercheck /usr/bin"),Object(c.b)("p",null,"sudo chmod 755 /usr/bin/clustercheck"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"$ sudo apt install xinetd")),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"$ service xinetd stop")),Object(c.b)("p",null,"sudo nano /etc/xinetd.d/mysqlchk"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"service mysqlchk\n{\n    disable = no\n    flags = REUSE\n    socket_type = stream\n    port = 9200\n    wait = no\n    user = nobody\n    server = /usr/bin/clustercheck\n    log_on_failure += USERID\n    only_from = 0.0.0.0/0\n    per_source = UNLIMITED\n}\n")),Object(c.b)("p",null,"sudo nano /etc/services"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"mysqlchk   9200/tcp    #Galera Clustercheck")),Object(c.b)("p",null,"\u6aa2\u67e5xinetd\u53caclustercheck\u662f\u5426\u6b63\u5e38\u904b\u4f5c\ntelnet localhost 9200"),Object(c.b)("p",null,"haproxy+MariaDB example"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{}),"listen mariadb_cluster_writes \n\n   bind 0.0.0.0:13304\n\n   mode tcp\n\n   option httpchk\n\n   server node01 10.0.2.6:3306 check port 9200\n\n   server node02 10.0.2.7:3306 check port 9200 backup\n")),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"\u554f\u984c\uff1a\u5982\u4f55\u6539\u8a2d\u5b9a\u6a94\u4e0d\u505c\u6a5f\uff1f\n","[name=\u4fca\u752b]")))}i.isMDXComponent=!0},233:function(e,n,t){"use strict";t.d(n,"a",(function(){return p})),t.d(n,"b",(function(){return m}));var r=t(0),a=t.n(r);function c(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){c(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function b(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},c=Object.keys(e);for(r=0;r<c.length;r++)t=c[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(r=0;r<c.length;r++)t=c[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=a.a.createContext({}),i=function(e){var n=a.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l({},n,{},e)),t},p=function(e){var n=i(e.components);return a.a.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.a.createElement(a.a.Fragment,{},n)}},d=Object(r.forwardRef)((function(e,n){var t=e.components,r=e.mdxType,c=e.originalType,o=e.parentName,s=b(e,["components","mdxType","originalType","parentName"]),p=i(t),d=r,m=p["".concat(o,".").concat(d)]||p[d]||u[d]||c;return t?a.a.createElement(m,l({ref:n},s,{components:t})):a.a.createElement(m,l({ref:n},s))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var c=t.length,o=new Array(c);o[0]=d;var l={};for(var b in n)hasOwnProperty.call(n,b)&&(l[b]=n[b]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var s=2;s<c;s++)o[s]=t[s];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,t)}d.displayName="MDXCreateElement"}}]);