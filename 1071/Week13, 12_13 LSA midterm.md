# Week13, 12/13 LSA midterm


Week 13 2018/12/13

è¦å‰‡ï¼š
- å¦‚æœ‰å•é¡Œè«‹èˆ‰æ‰‹ç™¼å•ã€‚
- è«‹åœ¨ç­”æ¡ˆç´™ä¸Šä½œç­”ã€‚
- è«‹å‹¿ç·¨è¼¯æœ¬é é¢ã€‚
- è«‹å‹¿ä»¥ç§è¨Šæˆ–èŠå¤©å®¤ç­‰ä»»ä½•æ–¹å¼å½¼æ­¤æºé€šã€‚
    - ç•¶ç„¶ä¹Ÿè«‹ä¸è¦ç›´æ¥å¯¦é«”æºé€šå•¦... é‚£ç®—ä½œå¼Šå–” ~>_^*
- å¯ä»¥ä¸Šç¶²è‡ªç”±åœ°æ‰¾è³‡æ–™ã€è£œå……é€™å­¸æœŸç›¸å°æ‡‰çš„å…±ç­†é é¢ã€‚
    - ä½†æ˜¯ä¸è¦ç›´æ¥æŠŠç­”æ¡ˆå…¨ç¯‡è²¼ä¸Šå–”ï½
        - å¯ä»¥è£œå……ç›¸é—œè³‡è¨Šã€æŒ‡ä»¤ç¯„ä¾‹ã€åƒè€ƒè³‡æ–™ä¾†æºç­‰ã€‚
        - åƒè€ƒè³‡æ–™ä¸å¯ä»¥æ˜¯ä½ å¯«çš„è§£ç­”é é¢ç­‰ã€‚
        - è£œå……çš„è³‡è¨Šä¸èƒ½èˆ‡è§£ç­”å®Œå…¨ç›¸åŒï¼Œè‡³å°‘è¦æ”¹æ‰ç›¸é—œåƒæ•¸ï¼ˆä¾‹å¦‚ IP ç­‰ï¼‰ã€‚

**We Are Watching You.**

# ç¬¬ä¸€å¤§é¡Œ 25%

- èª²ç¨‹çš„ä¸­æ–‡åç¨±ã€è‹±æ–‡åç¨±ã€è‹±æ–‡ç¸®å¯«ã€ä½ çš„çµ„åˆ¥è™Ÿã€‚5%
- è€å¸«çš„ä¸­æ–‡çœŸåã€è‹±æ–‡çœŸåã€å¸¸ç”¨ IDã€Telegram IDã€Facebook å€‹äººæª”æ¡ˆçš„åç¨±ã€å€‹äººç¶²ç«™çš„ç¶²å€ã€‚10%
- åŠ©æ•™ï¼ˆéæ„›å¿ƒåŠ©æ•™ï¼‰çš„ Telegram åç¨±æˆ–è‹±æ–‡ç¶½è™Ÿã€‚5%
- å¯«ä¸‰å€‹å°è€å¸«æˆ–é€™å ‚èª²å°è±¡æ·±åˆ»çš„é»ï¼Œæˆ–è€å¸«çš„å£é ­ç¦ªã€æ³¨æ„åˆ°çš„ç¿’æ…£ç­‰ã€‚5%

# ç¬¬äºŒå¤§é¡Œ 15%
è®“ç³»çµ±å®šæ™‚æ¯ 15 åˆ†é˜å‚™ä»½ä½ ç›®å‰é›»è…¦çš„æ•´å€‹ `/home` ç›®éŒ„åˆ°å‚™ä»½ä¸»æ©Ÿ `123.45.67.89` çš„ abc ä½¿ç”¨è€…å®¶ç›®éŒ„ä¸­çš„ `backups` è³‡æ–™å¤¾ï¼ˆç¾åœ¨é‚„ä¸å­˜åœ¨ï¼‰ã€‚
åœ¨å‚™ä»½ä¸»æ©Ÿä¸Šï¼Œæ¯å¤© 6:30 å’Œ 18:30 æ™‚ï¼Œä»¥ abc ä½¿ç”¨è€…çš„èº«ä»½ï¼Œè‡ªå‹•å°‡æ­¤å‚™ä»½è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰æª”æ¡ˆæ¬Šé™è¨­å®šç‚ºã€Œæ“æœ‰è€…å¯è®€å¯å¯«å¯åŸ·è¡Œï¼Œæ‰€æœ‰å…¶ä»–äººéƒ½ä¸å…·ä»»ä½•æ¬Šé™ã€ã€‚
- 123.45.67.89 ä¸»æ©Ÿæœ‰é–‹ sshã€‚
- ä½ æœ‰ abc é€™å€‹ä½¿ç”¨è€…çš„å¸³å¯†ã€‚
- æ¯ 15 åˆ†é˜è‡ªå‹•å‚™ä»½çš„éç¨‹ä¸­ï¼Œæ²’æ³•è¼¸å…¥å¯†ç¢¼ï¼Œé ˆè®“é€™å€‹éç¨‹ ssh èƒ½è‡ªå‹•èªè­‰ç™»å…¥å°æ–¹ä¸»æ©Ÿã€‚
- åªé ˆä¿ç•™æœ€æ–°è³‡æ–™ã€‚

è«‹å•è©²æ€éº¼è¨­å®šï¼Ÿ
è«‹å¯«å‡ºå„é—œéµæŒ‡ä»¤ï¼Œè‹¥é ˆåœ¨ç‰¹å®šç›®éŒ„æˆ–ç’°å¢ƒåŸ·è¡Œï¼Œä¹Ÿè«‹å¯«å‡ºã€‚
è‹¥æ˜¯æœ‰å…¶ä»–é—œéµç’°å¢ƒæˆ–è³‡è¨Šç­‰ï¼Œä¹Ÿè«‹å¯«å‡ºã€‚
ä¾‹ï¼šæ–¼ xxx ç›®éŒ„åŸ·è¡ŒæŒ‡ä»¤ `ooo` ä¸¦å°‡çµæœ www å† zzzã€‚
- è‡ªå‹•ç™»å…¥è¨­å®š 5%
- è‡ªå‹•å‚™ä»½è¨­å®š 5%
- è‡ªå‹•ä¿®æ”¹æ¬Šé™ 5%

# ç¬¬ä¸‰å¤§é¡Œ 80%

## æƒ…å¢ƒ

- 1. é€£ç·šåˆ° eth0 IP port 22 èƒ½é€£ä¸Š fw1 sshã€‚
- 2. é€£ç·šåˆ° eth0 IP port 22222 èƒ½é€£ä¸Š s3 sshã€‚
- 3. é€£ç·šåˆ° eth0 IP port 80 æœƒé€²å…¥ fw1 nginxï¼Œè€Œ nginx æœƒå‹•æ…‹ load balance (proxy) çµ¦ s1 lighttpd å’Œ s2 apacheã€‚
- 4. DMZ å…§çš„æ‰€æœ‰ä¸»æ©Ÿä¸èƒ½ä¸»å‹•é€£å¾€ BBIã€‚
- 5. DMZ å…§çš„æ‰€æœ‰ä¸»æ©Ÿï¼Œé™¤ s3 ä»¥å¤–ï¼Œä¸èƒ½ä¸»å‹•é€£åˆ° NATã€‚
- 6. s3 å¯ä»¥ä¸»å‹•é€£ç·šè‡³ NAT æ‰€æœ‰é›»è…¦çš„ sshï¼Œä¸èƒ½é€£å…¶ä»–æœå‹™ã€‚
- 7. NAT å…§çš„ä¸»æ©Ÿå¯ä»¥é€£å¾€ä»»ä½•åœ°æ–¹ã€‚

![](https://i.imgur.com/hB2M2r3.png)

## å•é¡Œ
1. fw1 eth0 æ‰€æ‹¿åˆ°çš„ IP èˆ‡ netmask æ–œç·šè¡¨ç­”æ³•è«‹ç…§å¯¦å¡«å…¥ã€‚5%
2. fw1 eth0 æ‰€è™•åœ¨çš„ç¶²è·¯ç’°å¢ƒçš„èµ·å§‹ IP èˆ‡çµå°¾ IPã€‚10%
3. fw1 eth1, eth2 çš„ç¶²å¡ IP èˆ‡ netmask æ–œç·šè¡¨ç­”æ³•ã€‚10%
4. NAT èˆ‡ DMZ ç¶²æ®µåˆ†åˆ¥çš„èµ·å§‹ IP èˆ‡çµå°¾ IPã€‚10%
5. fw1 ä¸Šçš„ iptables è¦å‰‡ï¼ˆå¯æŠ½è±¡ç¸®å¯«ï¼Œä½†é—œéµåƒæ•¸é ˆå¯«å‡ºï¼‰ã€‚20%
6. fw1, s1, s2 ä¸Šåˆ†åˆ¥çš„ï¼š15%
    - è»Ÿé«”å®‰è£æŒ‡ä»¤ã€‚
    - è»Ÿé«”è¨­å®šæª”çš„ä½ç½®ã€‚
    - è‹¥é ˆä¿®æ”¹è¨­å®šæª”ï¼Œå¯«å‡ºé ˆä¿®æ”¹çš„é—œéµå…§å®¹ï¼ˆå¯æŠ½è±¡ç¸®å¯«ï¼Œä½†é—œéµè¨­å®šèˆ‡åƒæ•¸é ˆå¯«å‡ºï¼‰ã€‚
7. s1, s2, s3 çš„ ufw é˜²ç«ç‰†è¦å‰‡ï¼ˆå¯æŠ½è±¡ç¸®å¯«ï¼Œä½†é—œéµåƒæ•¸é ˆå¯«å‡ºï¼‰ã€‚10%



# åŠ åˆ†é¡Œï¼ˆæ–‡é•·ï¼‰ 15%
é€™æ˜¯æ›¾ç¶“çœŸå¯¦ç™¼ç”Ÿçš„å•é¡Œã€‚

## æƒ…å¢ƒ


è³‡ç®¡ç³»æœ‰ä¸€å° server ï¼ŒåŒæ™‚è¨­å®šäº†è¨±å¤š DNS ç´€éŒ„æŒ‡å‘é€™å°æ©Ÿå™¨ï¼ŒåŒ…å« `web.im.ncnu.edu.tw` èˆ‡ `temp.im.ncnu.edu.tw` ã€‚
åœ¨é€™å°æ©Ÿå™¨ä¸Šçš„ _Nginx_ è¨­å®šäº† _Virtual Host_ ä¾æ“šå®¢æˆ¶ç«¯é€£é€²ä¾†æ™‚æä¾›çš„ HTTP Header `Host:` ä¾†æä¾›ä¸åŒè™›æ“¬ç¶²ç«™çš„å…§å®¹ã€‚

æŸå¤©ï¼Œè‹¦å‘½å°çŒ´å­ ğŸ™‰ ç™¼ç¾äº†å¥‡æ€ªçš„å•é¡Œï¼Œè¶•ç·Šæ±‚åŠ©æ”»åŸæº¼ â››ç›¸åŠ©ã€‚å¥‡æ€ªçš„ç‹€æ³å¦‚ä¸‹ï¼š
- éµç›¤æŸ¯å— âŒ¨ åœ¨å­¸æ ¡å…§ç¶²ä½¿ç”¨ç€è¦½å™¨åŠ _curl_ æ¸¬è©¦é€£åˆ° `http://temp.im.ncnu.edu.tw` æ™‚ï¼Œçš†æœƒè¢« __éŒ¯èª¤åœ°__ æ”¶åˆ° HTTP 301  `https://web.im.ncnu.edu.tw`ã€‚
- åœ¨ BBI è¦é€£åˆ°é€™å°æ©Ÿå™¨æ™‚ï¼Œå‰‡æœƒå› ä¸åŒ client æœ‰ä¸åŒçš„ç‹€æ³ï¼Œæœ‰äº›èƒ½æ­£ç¢ºåœ°é–‹å•Ÿ `http://temp.im.ncnu.edu.tw`ï¼Œæœ‰äº›å»æœƒè¢«éŒ¯èª¤åœ°æ”¶åˆ° HTTP 301 `https://web.im.ncnu.edu.tw`ã€‚èˆ‰ä¾‹å¦‚ä¸‹ï¼š
    - å•¤é…’å“¥ ğŸº ä½åœ¨æ–°åŠ å¡èŠ±å¤©é…’åœ°ï¼Œåœ¨ Pub è£¡ç”¨ Google Pixel 3 XL æ‰‹æ©Ÿä¸Šçš„ Android ç‰ˆ Chrome ï¼Œä»¥åŠé è¨­ Ubuntu 18.04 çš„ Dell XPS 13 ç­†é›»ä¸Šçš„ Firefox ï¼Œéƒ½èƒ½æ­£ç¢ºé–‹å•Ÿ `http://temp.im.ncnu.edu.tw`ã€‚æ€éº¼è©¦éƒ½æ­£å¸¸ã€‚å¯¦åœ¨æº«æ‹¿ã€‚
    - ä¸‰åå¸æ¬¸æ¯ ğŸ¤“ åœ¨å°ç£ç§‘æŠ€å®…éƒ½è©²åƒåŠ çš„ COSCUP 2018 ç ”è¨æœƒï¼Œé–‹è‘—ä¸‰å°ç­†é›»é‚Šè½è­°ç¨‹é‚Šä½œç­†è¨˜é‚Šæ‰“ 0.A.D é‚Šé€› PTTï¼Œä¸è«–ä½¿ç”¨ IBM Thinkpad X61 ä¸Šçš„ Ubuntu Linux 16.04ï¼Œæˆ– ASUS whatever ä¸Šçš„ Windows 10 Home Editionï¼Œæˆ– Mac OSX on MacBook Pro 2018 Touchbarï¼Œä¸è«–ä½¿ç”¨ Chrome / Firefox / Safari / Edge / curl ç­‰ï¼Œå…¨éƒ¨éƒ½æœƒè¢«éŒ¯èª¤åœ°æ”¶åˆ° 301 `https://web.im.ncnu.edu.tw`ã€‚é€£ç•¶å·¥å…·äººéƒ½å¤±æ•—ï¼Œäººç”Ÿå¥½è‹¦ã€‚

## å•é¡Œ

- è«‹å•é€ æˆéŒ¯èª¤çš„åŸå› ï¼Ÿ 10%
- ä¿®æ­£çš„æ–¹å¼æ˜¯ï¼Ÿ5%

## ç’°å¢ƒé…ç½®åŠç›¸é—œè³‡è¨Š

### DNS æŸ¥è©¢å‡ºä¾†çš„çš„ç¢ºæ˜¯åŒä¸€å°ï¼Œé…ç½®æ­£ç¢º
```
$ host web.im.ncnu.edu.tw
web.im.ncnu.edu.tw has address 163.22.17.179
web.im.ncnu.edu.tw has IPv6 address 2001:e10:6840:17::179
$ host temp.im.ncnu.edu.tw
temp.im.ncnu.edu.tw is an alias for web.im.ncnu.edu.tw.
web.im.ncnu.edu.tw has address 163.22.17.179
web.im.ncnu.edu.tw has IPv6 address 2001:e10:6840:17::179
```

### å…©å€‹å¤–ç¶²ä½¿ç”¨è€…çš„ç¶²è·¯é…ç½®

- å•¤é…’å“¥ ğŸº èƒ½æ­£ç¢ºé–‹å•Ÿ `http://temp.im.ncnu.edu.tw`
    - å•¤é…’å“¥ ğŸº çš„ç¶²è·¯ç•Œé¢è³‡è¨Šå¦‚ä¸‹ï¼š
        ```
        $ ifconfig eth0
        eth0        Link encap:Ethernet  HWaddr aa:dd:bb:77:cc:ab
                    inet addr:188.166.188.226  Bcast:188.166.191.255  Mask:255.255.240.0
                    inet6 addr: fe80::28d7:b6ff:fe78:c80f/64 Scope:Link
                    UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
                    RX packets:22086524 errors:0 dropped:0 overruns:0 frame:0
                    TX packets:26906826 errors:0 dropped:0 overruns:0 carrier:0
                    collisions:0 txqueuelen:1000 
                    RX bytes:5059910282 (5.0 GB)  TX bytes:15538027725 (15.5 GB)

        $ route -n
        Kernel IP routing table
        Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
        0.0.0.0         188.166.176.1   0.0.0.0         UG    0      0        0 eth0
        10.15.0.0       0.0.0.0         255.255.0.0     U     0      0        0 eth0
        188.166.176.0   0.0.0.0         255.255.240.0   U     0      0        0 eth0
        ```
- ä¸‰åå¸æ¬¸æ¯ ğŸ¤“ è¢«éŒ¯èª¤åœ° redirect 301 åˆ° `https://web.im.ncnu.edu.tw`
    - ä¸‰åå¸æ¬¸æ¯ ğŸ¤“ çš„ç¶²è·¯ç•Œé¢è³‡è¨Šå¦‚ä¸‹ï¼š
        ```
        $ ifconfig wlan0
        wlan0     Link encap:Ethernet  HWaddr 28:b2:bd:15:f5:04  
                  inet addr:192.168.88.81  Bcast:192.168.88.255  Mask:255.255.255.0
                  inet6 addr: 2001:b011:800e:1fc6:aa78:85e0:d9bd:a7e3/64 Scope:Global
                  inet6 addr: fe80::50a0:c0d:b969:a2cc/64 Scope:Link
                  UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
                  RX packets:13225793 errors:0 dropped:1 overruns:0 frame:0
                  TX packets:5389065 errors:0 dropped:0 overruns:0 carrier:0
                  collisions:0 txqueuelen:1000 
                  RX bytes:14057693740 (14.0 GB)  TX bytes:4665358526 (4.6 GB)
        $ route -n
        Kernel IP routing table
        Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
        0.0.0.0         192.168.88.254  0.0.0.0         UG    600    0        0 wlan0
        169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 br-17b8c74c4d5f
        172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
        172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-17b8c74c4d5f
        192.168.88.0    0.0.0.0         255.255.255.0   U     600    0        0 wlan0
        192.168.122.0   0.0.0.0         255.255.255.0   U     0      0        0 virbr0
        ```
    - è¢«éŒ¯èª¤åœ° redirect 301 æ™‚ï¼Œä»¥ curl æ¸¬è©¦çš„ç¾è±¡
        ![](https://i.imgur.com/gwqDcpL.png)


### ä¼ºæœå™¨ Nginx config

#### Default host
For `*.im.ncnu.edu.tw`

```conf
server {
        if ($host = web.im.ncnu.edu.tw) {
                return 301 https://$host$request_uri;
        } # managed by Certbot

        listen 80 default_server;
        listen [::]:80 default_server;
        server_name web.im.ncnu.edu.tw;
        return 301 https://$server_name$request_uri;
    
}

server {
        listen 443 ssl http2 default_server;
        listen [::]:443 ssl http2 default_server;
        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html index.php;

        server_name web.im.ncnu.edu.tw;

        location / {
                
                try_files $uri $uri/ =404;
        }
        location ~ \.php$ {
                fastcgi_pass unix:/run/php/php7.0-fpm.sock;
        }

        ssl_certificate /KEY/DIRECTORY/fullchain.pem; # managed by Certbot
        ssl_certificate_key /KEY/DIRECTORY/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

```


#### Virtual host

`temp.im.ncnu.edu.tw` çš„ virtual host config


```conf
server {
    listen 80;
 
    server_name temp.im.ncnu.edu.tw;
    server_name_in_redirect off;

    access_log /var/log/nginx/temp_demo.access_log;
    error_log /var/log/nginx/temp_demo.error_log info;

    root /var/www/temp_demo;
    index index.php index.html index.htm default.html default.htm;
    
    # php setting å·²æª¢æŸ¥éæ²’æœ‰å•é¡Œ
    include snippets/joomla.conf;

}
```


